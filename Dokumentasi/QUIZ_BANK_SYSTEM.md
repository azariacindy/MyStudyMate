# üß† Quiz Bank System - MyStudyMate

## üìö Konsep Sistem Bank Soal

Sistem ini mengoptimalkan penggunaan AI dengan **generate sekali, pakai berkali-kali**.

### ‚úÖ Alur Sistem

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  USER: Klik "Mulai Quiz" pertama kali                       ‚îÇ
‚îÇ  ‚Üì                                                           ‚îÇ
‚îÇ  BACKEND: Cek apakah ada bank soal untuk study card ini?    ‚îÇ
‚îÇ  ‚îú‚îÄ TIDAK ADA ‚Üí Generate via AI (Gemini/DeepSeek)          ‚îÇ
‚îÇ  ‚îÇ              ‚Üí Simpan ke bank soal (is_bank_question=1)  ‚îÇ
‚îÇ  ‚îÇ              ‚Üí Return quiz instance                      ‚îÇ
‚îÇ  ‚îî‚îÄ SUDAH ADA ‚Üí Ambil dari bank soal                       ‚îÇ
‚îÇ                 ‚Üí Copy & acak jawaban                        ‚îÇ
‚îÇ                 ‚Üí Update usage_count                        ‚îÇ
‚îÇ                 ‚Üí Return quiz instance                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Backend Implementation (Laravel)

### 1. **QuizService.php** - Main Logic

#### **generateQuizFromAI()**
```php
public function generateQuizFromAI(int $studyCardId, array $options = []): Quiz
{
    $bankQuestions = $this->getBankQuestions($studyCardId);
    
    // PERTAMA KALI: Generate via AI
    if (empty($bankQuestions)) {
        return $this->generateAndSaveToBankOnce($studyCard, $numQuestions, $options);
    }
    
    // KEDUA KALINYA: Ambil dari bank
    return $this->createQuizFromBank($studyCard, $selectedQuestions, $options);
}
```

#### **generateAndSaveToBankOnce()** - Generate & Save
```php
private function generateAndSaveToBankOnce(StudyCard $studyCard, int $numQuestions, array $options = []): Quiz
{
    // 1. Extract material content (PDF/Text)
    $materialContent = $this->extractMaterialContent($studyCard);
    
    // 2. Call AI API (Gemini or DeepSeek)
    $questionsData = $this->callGeminiAPI($prompt);
    
    // 3. Create quiz master (bank soal)
    $quiz = $this->repository->create([
        'title' => $studyCard->title . ' - Bank Soal',
        'description' => 'Master question bank generated by AI',
        'generated_by_ai' => true,
        'ai_model' => 'gemini',
    ]);
    
    // 4. Save ALL questions to bank
    foreach ($questionsData as $questionData) {
        $question = $quiz->questions()->create([
            'question_text' => $questionData['question_text'],
            'is_bank_question' => true, // ‚úÖ Master bank
            'usage_count' => 0,
            'last_used_at' => null,
        ]);
        
        // Save answers
        foreach ($questionData['answers'] as $answerData) {
            $question->answers()->create([...]);
        }
    }
    
    return $quiz->load('questions.answers');
}
```

#### **createQuizFromBank()** - Reuse from Bank
```php
private function createQuizFromBank(StudyCard $studyCard, array $bankQuestions, array $options = []): Quiz
{
    // 1. Create quiz instance (bukan master bank)
    $quiz = $this->repository->create([
        'title' => $studyCard->title . ' - Quiz ' . now()->format('d/m/Y H:i'),
        'description' => 'Quiz from question bank (no AI generation needed)',
        'generated_by_ai' => true,
        'ai_model' => 'bank', // ‚úÖ Dari bank soal
    ]);
    
    // 2. Copy questions from bank
    foreach ($bankQuestions as $bankQuestion) {
        $question = $quiz->questions()->create([
            'is_bank_question' => false, // ‚úÖ Instance quiz
            // ... copy data dari bank
        ]);
        
        // Copy & shuffle answers
        shuffle($answers);
        foreach ($answers as $bankAnswer) {
            $question->answers()->create([...]);
        }
        
        // 3. Update usage count di bank master
        QuizQuestion::where('id', $bankQuestion['id'])
            ->increment('usage_count');
    }
    
    return $quiz->load('questions.answers');
}
```

---

## üì± Flutter Implementation

### 1. **study_card_detail_screen.dart** - UI Layer

#### **Loading Dialog**
```dart
// Smart loading message based on material type
Text(
  widget.studyCard.isFileType 
      ? 'First-time may take 15-30 seconds'  // PDF = generate via AI
      : 'Loading from question bank...',      // Subsequent = from bank
  style: TextStyle(fontSize: 12, fontStyle: FontStyle.italic),
)
```

#### **Error Handling**
```dart
// Specific error messages for common issues
if (errorStr.contains('pdf') && errorStr.contains('image')) {
    errorMessage = 'Cannot generate quiz from image-based PDF';
    actionHint = 'Please use text-based PDF or text material';
} else if (errorStr.contains('no text') || errorStr.contains('empty')) {
    errorMessage = 'No text content found in material';
    actionHint = 'Ensure your material contains readable text';
}
```

#### **Info Banner**
```dart
// Educate users about question bank system
Container(
  child: Row(
    children: [
      Icon(Icons.lightbulb_outline, color: Color(0xFF3B82F6)),
      Text('AI akan generate bank soal pertama kali, berikutnya langsung pakai dari bank'),
    ],
  ),
)
```

### 2. **study_card_service.dart** - API Layer

```dart
Future<Map<String, dynamic>> generateQuiz(int studyCardId, {int questionCount = 5}) async {
  final response = await _dio.post(
    'study-cards/$studyCardId/generate-quiz',
    data: {'question_count': questionCount},
    options: Options(
      receiveTimeout: const Duration(seconds: 90), // Long timeout for AI
    ),
  );
  
  return response.data['data'];
}
```

---

## üóÑÔ∏è Database Schema

### **quizzes** Table
```sql
- id (PK)
- study_card_id (FK)
- title
- description
- total_questions
- generated_by_ai (boolean)
- ai_model (gemini|deepseek|bank)  -- 'bank' = from question bank
```

### **quiz_questions** Table
```sql
- id (PK)
- quiz_id (FK)
- question_text
- question_type (multiple_choice)
- is_bank_question (boolean)  -- TRUE = master bank, FALSE = quiz instance
- usage_count (int)            -- How many times used
- last_used_at (timestamp)     -- Last usage timestamp
- topic
- difficulty_level
```

### **quiz_answers** Table
```sql
- id (PK)
- question_id (FK)
- answer_text
- is_correct (boolean)
- order_number
```

---

## üéØ Key Benefits

### ‚úÖ **Performance**
- ‚ùå **Before**: Generate via AI setiap kali (15-30 detik)
- ‚úÖ **After**: Generate sekali, reuse dari bank (<2 detik)

### ‚úÖ **Cost Efficiency**
- ‚ùå **Before**: API call setiap quiz ‚Üí mahal
- ‚úÖ **After**: API call sekali per study card ‚Üí hemat

### ‚úÖ **Consistency**
- ‚úÖ Soal konsisten dan sudah di-review
- ‚úÖ Bisa track usage statistics (usage_count, last_used_at)
- ‚úÖ Bisa improve bank soal dari feedback user

### ‚úÖ **Flexibility**
- ‚úÖ Jawaban di-acak setiap kali (shuffle answers)
- ‚úÖ Bisa tambah soal baru ke bank manual
- ‚úÖ Bisa edit/delete soal dari bank

---

## üîç Query Examples

### Get Bank Questions for Study Card
```php
$bankQuestions = QuizQuestion::where('is_bank_question', true)
    ->whereHas('quiz', function($q) use ($studyCardId) {
        $q->where('study_card_id', $studyCardId);
    })
    ->with('answers')
    ->orderBy('order_number', 'asc')
    ->get();
```

### Get Most Used Questions
```php
$popularQuestions = QuizQuestion::where('is_bank_question', true)
    ->orderBy('usage_count', 'desc')
    ->take(10)
    ->get();
```

### Get Recently Used Questions
```php
$recentQuestions = QuizQuestion::where('is_bank_question', true)
    ->whereNotNull('last_used_at')
    ->orderBy('last_used_at', 'desc')
    ->take(10)
    ->get();
```

---

## üöÄ Future Enhancements

### 1. **Smart Question Selection**
```php
// Prioritize less-used questions
$questions = QuizQuestion::where('is_bank_question', true)
    ->orderBy('usage_count', 'asc')  // Prefer unused questions
    ->orderBy('last_used_at', 'asc') // Prefer old questions
    ->limit($numQuestions)
    ->get();
```

### 2. **Difficulty Progression**
```php
// Start easy, get harder
$questions = [
    ...getBankQuestions('easy', 2),
    ...getBankQuestions('medium', 2),
    ...getBankQuestions('hard', 1),
];
```

### 3. **User Feedback Integration**
```php
// Add user ratings to questions
quiz_questions:
- user_rating (float)
- times_answered_correctly (int)
- times_answered_incorrectly (int)
```

### 4. **Manual Bank Management**
```php
// Admin/User can:
- Add questions manually to bank
- Edit existing bank questions
- Delete poor-quality questions
- Mark questions as "needs review"
```

---

## üìä Monitoring & Analytics

### Track Quiz Performance
```php
// Average score per study card
SELECT 
    sc.title,
    AVG(qr.score) as avg_score,
    COUNT(qr.id) as total_attempts
FROM study_cards sc
JOIN quizzes q ON q.study_card_id = sc.id
JOIN quiz_results qr ON qr.quiz_id = q.id
GROUP BY sc.id;
```

### Track Question Quality
```php
// Questions with low correct rate = need improvement
SELECT 
    qq.question_text,
    qq.usage_count,
    (correct_count / qq.usage_count * 100) as correct_percentage
FROM quiz_questions qq
WHERE qq.is_bank_question = true
ORDER BY correct_percentage ASC;
```

---

## ‚úÖ Testing Checklist

### Backend
- [ ] Generate quiz first time (AI call)
- [ ] Generate quiz second time (from bank)
- [ ] Shuffle answers correctly
- [ ] Update usage_count correctly
- [ ] Handle PDF extraction
- [ ] Handle text material
- [ ] Handle API timeout
- [ ] Handle empty material
- [ ] Fallback to dummy quiz on error

### Flutter
- [ ] Show correct loading message (first vs subsequent)
- [ ] Display helpful error messages
- [ ] Show info banner about bank system
- [ ] Navigate to quiz screen correctly
- [ ] Handle network errors
- [ ] Handle timeout errors
- [ ] Retry mechanism works

---

## üìù Conclusion

Sistem bank soal ini mengoptimalkan:
1. **Performance** - Fast quiz generation
2. **Cost** - Minimal AI API calls
3. **Quality** - Consistent, reviewed questions
4. **Scalability** - Easy to expand and maintain

‚úÖ **Generate once, reuse forever!**
